name: Sovereign Integrity Check (CI)

on: [push, pull_request]

jobs:
  # Job 1: Lockfile Validation (Supply Chain Integrity)
  lockfile-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install packaging for version comparison
        run: pip install packaging

      - name: Validate Lockfile
        # Note: --strict would fail on missing hashes. Without it, missing hashes are warnings.
        # Enable --strict in production for full supply chain integrity enforcement.
        run: |
          python scripts/validate_lockfile.py --check || echo "::warning::Lockfile validation detected issues. Review lockfile_status.json for details."

      - name: Upload lockfile status
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lockfile-status
          path: lockfile_status.json

  # Job 2: DSL Theorem Verification (Risk Threshold Enforcement)
  verify-theorems:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install numpy pyyaml

      - name: Run DSL Theorem Compiler
        run: |
          python scripts/verify_theorems.py --output theorem_output.json --threshold 0.001

      - name: Upload theorem output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: theorem-output
          path: theorem_output.json

  build-and-test:
    runs-on: ubuntu-latest
    needs: [lockfile-validation, verify-theorems]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for secret scanning history

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies (including pre-commit for CI)
        run: |
          python -m pip install --upgrade pip
          # Install all dependencies, including dev requirements
          pip install -r requirements.txt || true
          pip install -r requirements_dev.txt || pip install pre-commit pytest pytest-cov
          # Ensure pre-commit is available
          pip install pre-commit
          # Install additional security tools
          pip install bandit safety detect-secrets mypy pip-licenses
          # Install cryptography for Ed25519 signature verification
          pip install cryptography

      - name: Run Full Pre-Commit Suite (Lint, Format, Bandit, Mypy)
        run: |
          # This runs ALL hooks defined in .pre-commit-config.yaml against ALL files.
          pre-commit run --all-files || true

      - name: Run Security Scan (Bandit)
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt || true

      - name: Run Dependency Vulnerability Scan (Safety)
        run: |
          safety check --json || true

      - name: Static Type Check (mypy)
        run: |
          mypy --install-types --non-interactive || true
          mypy src || true

      - name: Generate SBOM (pip-licenses)
        run: |
          pip-licenses --format=json --with-license-file > sbom.json || true

      - name: Upload SBOM
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

      - name: Run Main Test Suite
        run: |
          pip install pytest pytest-cov numpy
          pytest -q tests/ -k "not adversarial" --maxfail=1 --disable-warnings --cov=src --cov-report=xml

      - name: Run Manifest & Kernel Security Tests
        run: |
          pytest -q tests/test_manifest_signature.py tests/test_kernel_metadata_tamper.py tests/test_composition_proof.py --maxfail=1 --disable-warnings -v

      - name: Run Phase 4 Security Enhancements
        run: |
          pytest -q tests/test_source_flooding.py tests/test_proof_meta_checks.py tests/test_ux_semantic_audit.py tests/test_counterfactual_rare_events.py --maxfail=1 --disable-warnings -v

      - name: Run Adversarial Test Battery
        run: |
          pytest -q tests/adversarial/ --maxfail=1 --disable-warnings -v

      - name: Run Violation Heuristics Tests
        run: |
          pytest -q tests/test_violation_heuristics.py --maxfail=1 --disable-warnings -v

      - name: Upload coverage reports to Codecov (Rigor & Auditability Gate)
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

  # Job 4: Append Results to Audit Ledger
  audit-ledger:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Download theorem output
        uses: actions/download-artifact@v4
        with:
          name: theorem-output
          path: artifacts/

      - name: Append to Audit Ledger
        run: |
          mkdir -p audit
          echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") - CI Audit Entry" >> audit/ci_audit.log
          cat artifacts/theorem_output.json >> audit/theorem_ledger.jsonl || true
