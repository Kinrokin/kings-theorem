name: Sovereign Integrity Check (CI)

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for secret scanning history

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies (including pre-commit for CI)
        run: |
          python -m pip install --upgrade pip
          # Install all dependencies, including dev requirements
          pip install -r requirements.txt || true
          pip install -r requirements_dev.txt || pip install pre-commit pytest pytest-cov
          # Ensure pre-commit is available
          pip install pre-commit
          # Install additional security tools
          pip install bandit safety detect-secrets
          # Install cryptography for Ed25519 signature verification
          pip install cryptography

      - name: Run Full Pre-Commit Suite (Lint, Format, Bandit, Mypy)
        run: |
          # This runs ALL hooks defined in .pre-commit-config.yaml against ALL files.
          pre-commit run --all-files || true

      - name: Run Security Scan (Bandit)
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt || true

      - name: Run Dependency Vulnerability Scan (Safety)
        run: |
          safety check --json || true

      - name: Run Main Test Suite
        run: |
          pip install pytest pytest-cov numpy
          pytest -q tests/ -k "not adversarial" --maxfail=1 --disable-warnings --cov=src --cov-report=xml

      - name: Run Manifest & Kernel Security Tests
        run: |
          pytest -q tests/test_manifest_signature.py tests/test_kernel_metadata_tamper.py tests/test_composition_proof.py --maxfail=1 --disable-warnings -v

      - name: Run Phase 4 Security Enhancements
        run: |
          pytest -q tests/test_source_flooding.py tests/test_proof_meta_checks.py tests/test_ux_semantic_audit.py tests/test_counterfactual_rare_events.py --maxfail=1 --disable-warnings -v

      - name: Run Adversarial Test Battery
        run: |
          pytest -q tests/adversarial/ --maxfail=1 --disable-warnings -v

      - name: Upload coverage reports to Codecov (Rigor & Auditability Gate)
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}
