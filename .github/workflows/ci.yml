name: Sovereign Integrity Check (CI)

on: [push, pull_request]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for secret scanning history

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies (including pre-commit for CI)
        run: |
          python -m pip install --upgrade pip
          # Install all dependencies, including dev requirements
          pip install -r requirements.txt || true
          pip install -r requirements_dev.txt || pip install pre-commit pytest pytest-cov
          # Ensure pre-commit is available
          pip install pre-commit
          # Install additional security tools
          pip install bandit safety detect-secrets mypy pip-licenses
          # Install cryptography for Ed25519 signature verification
          pip install cryptography
          # Install pip-tools for lockfile verification
          pip install pip-tools
          # Strict pin & hash verification (fails CI if mismatch)
          python scripts/verify_lockfile.py

      - name: Run Full Pre-Commit Suite (Lint, Format, Bandit, Mypy)
        run: |
          # This runs ALL hooks defined in .pre-commit-config.yaml against ALL files.
          pre-commit run --all-files || true

      - name: Run Security Scan (Bandit)
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt || true

      - name: Run Dependency Vulnerability Scan (Safety)
        run: |
          safety check --json || true

      - name: Static Type Check (mypy)
        run: |
          mypy --install-types --non-interactive || true
          mypy src || true

      - name: Generate SBOM (pip-licenses)
        run: |
          pip-licenses --format=json --with-license-file > sbom.json || true

      - name: Upload SBOM
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

      - name: Run Main Test Suite
        run: |
          pip install pytest pytest-cov numpy
          pytest -q tests/ -k "not adversarial" --maxfail=1 --disable-warnings --cov=src --cov-report=xml

      - name: Run Manifest & Kernel Security Tests
        run: |
          pytest -q tests/test_manifest_signature.py tests/test_kernel_metadata_tamper.py tests/test_composition_proof.py --maxfail=1 --disable-warnings -v

      - name: Run Phase 4 Security Enhancements
        run: |
          pytest -q tests/test_source_flooding.py tests/test_proof_meta_checks.py tests/test_ux_semantic_audit.py tests/test_counterfactual_rare_events.py --maxfail=1 --disable-warnings -v

      - name: Run Adversarial Test Battery
        run: |
          pytest -q tests/adversarial/ --maxfail=1 --disable-warnings -v

      - name: Constitutional Invariants (Bias/Emotion/Composition)
        run: |
          python scripts/ci_bias_invariants.py

      - name: Revocation Chain Integrity
        run: |
          python scripts/verify_revocation_chain.py

      - name: DSL Theorem Verification & CI Gating
        run: |
          python scripts/ci_dsl_theorems.py

      - name: Risk Budget Enforcement
        run: |
          python scripts/check_risk_budget.py

      # Codecov disabled until CODECOV_TOKEN secret configured
      # To enable: Add secret in GitHub → Settings → Secrets → Actions → CODECOV_TOKEN
      # - name: Upload coverage reports to Codecov (Rigor & Auditability Gate)
      #   uses: codecov/codecov-action@v3
      #   with:
      #     files: ./coverage.xml
      #     fail_ci_if_error: true
      #     token: ${{ secrets.CODECOV_TOKEN }}
